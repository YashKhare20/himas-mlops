# Cloud Build with Cloud Run Deployment
steps:
  # Build training container
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-training-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/himas-training:latest'
      - '-f'
      - 'PoC/Model-Pipeline/himas-model-pipeline/Dockerfile'
      - 'PoC/Model-Pipeline/himas-model-pipeline/'

  # Train model
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'train-model'
    env:
      - 'GCP_PROJECT_ID=$PROJECT_ID'
      - 'DATASET_ID=federated'
      - 'DATASET_ID=federated'
      - 'MLFLOW_TRACKING_URI=file:///workspace/mlruns'
      - 'MLFLOW_EXPERIMENT_NAME=himas-federated-training'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cp -r /workspace/PoC/Model-Pipeline/himas-model-pipeline/* /app/
        cd /app
        echo "Starting training with federated..."
        echo "Starting training..."
        flwr run .
        mkdir -p /workspace/models
        
        MODEL_FILE=$$(find models -name "*.keras" -type f | head -1)
        if [ -z "$$MODEL_FILE" ]; then
          echo "âŒ No model file found!"
          exit 1
        fi
        
        cp $$MODEL_FILE /workspace/models/model.keras
        echo "âœ… Model saved"

  # Create timestamp
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'create-timestamp'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(date +%Y%m%d_%H%M%S)
        echo "$$TIMESTAMP" > /workspace/build_timestamp.txt
        echo "ðŸ“… Timestamp: $$TIMESTAMP"

  # Evaluate model
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'evaluate-model'
    env:
      - 'GCP_PROJECT_ID=$PROJECT_ID'
      - 'DATASET_ID=federated'
      - 'DATASET_ID=federated'
      - 'MLFLOW_TRACKING_URI=file:///workspace/mlruns'
      - 'MLFLOW_EXPERIMENT_NAME=himas-federated-eval'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cp -r /workspace/PoC/Model-Pipeline/himas-model-pipeline/* /app/
        cd /app
        mkdir -p models
        cp /workspace/models/model.keras models/
        cp -r /workspace/mlruns /app/ || echo "No mlruns"
        
        rm -rf evaluation_results
        mkdir -p evaluation_results
        python scripts/evaluate_model.py
        cp -r evaluation_results /workspace/
        cp -r /app/mlruns /workspace/ || echo "No mlruns"

  # Validate metrics
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'validate-metrics'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd /workspace
        LATEST_JSON=$$(ls -t evaluation_results/results/*.json | head -1)
        ACC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .accuracy' $$LATEST_JSON)
        REC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .recall' $$LATEST_JSON)
        
        echo "Metrics - Accuracy: $$ACC | Recall: $$REC"
        
        # Check accuracy threshold (85%)
        if (( $$(echo "$$ACC < 0.85" | bc -l) )); then
          echo "âŒ FAILED: Accuracy ($$ACC) is below threshold (0.85)"
          exit 1
        fi
        
        # Check recall threshold (70%)
        if (( $$(echo "$$REC < 0.70" | bc -l) )); then
          echo "âŒ FAILED: Recall ($$REC) is below threshold (0.70)"
          exit 1
        fi
        
        echo "âœ… Metrics passed - Accuracy: $$ACC | Recall: $$REC"

  # Bias detection
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'bias-detection'
    env:
      - 'GCP_PROJECT_ID=$PROJECT_ID'
      - 'DATASET_ID=federated'
      - 'DATASET_ID=federated'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        cp -r /workspace/PoC/Model-Pipeline/himas-model-pipeline/* /app/
        cd /app
        mkdir -p models
        cp /workspace/models/model.keras models/
        
        python bias_detection/detect_bias.py \
          --model-path models/model.keras \
          --threshold 0.5 \
          --dp-threshold 0.6 \
          --eo-threshold 1.1 \
          --output-dir bias_detection_results
      
        python bias_detection/bias_checker.py \
          --bias-summary bias_detection_results/reports/bias_summary.json \
          --threshold-demographic-parity 0.6 \
          --threshold-equalized-odds 1.1
        
        cp -r bias_detection_results /workspace/

  # Compare with previous
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'compare-with-previous'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd /workspace
        LATEST_JSON=$$(ls -t evaluation_results/results/*.json | head -1)
        NEW_ACC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .accuracy' $$LATEST_JSON)
        NEW_REC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .recall' $$LATEST_JSON)

        gsutil cp gs://himas-mlops-models/model-registry/latest.txt . || {
          echo "First model - proceeding."
          exit 0
        }
        
        PREV_TIMESTAMP=$$(cat latest.txt)
        if [ -z "$$PREV_TIMESTAMP" ]; then
          echo "First model - proceeding."
          exit 0
        fi
        
        mkdir -p prev_results
        gsutil cp -r gs://himas-mlops-models/evaluation-results/$$PREV_TIMESTAMP/evaluation_results/results/ prev_results/ || {
          echo "Could not fetch previous results."
          exit 0
        }
        
        PREV_LATEST=$$(find prev_results -name "*.json" -type f | head -1)
        PREV_LATEST=$$(find prev_results -name "*.json" -type f | head -1)
        PREV_ACC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .accuracy' $$PREV_LATEST)
        PREV_REC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .recall' $$PREV_LATEST)
        
        ACC_DIFF=$$(echo "$$NEW_ACC - $$PREV_ACC" | bc -l)
        REC_DIFF=$$(echo "$$NEW_REC - $$PREV_REC" | bc -l)
        
        if (( $$(echo "$$ACC_DIFF < -0.02" | bc -l) )) || (( $$(echo "$$REC_DIFF < -0.02" | bc -l) )); then
          echo "âŒ New model worse"
          echo "Previous Accuracy: $$PREV_ACC | New Accuracy: $$NEW_ACC"
          echo "Previous Recall: $$PREV_REC | New Recall: $$NEW_REC"
          exit 1
        fi

  # Upload model
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-model'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        gsutil cp /workspace/models/model.keras \
          gs://himas-mlops-models/models/$${TIMESTAMP}/model.keras

  # Upload preprocessing
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-preprocessing'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        gsutil -m cp -r /workspace/PoC/Model-Pipeline/himas-model-pipeline/models/preprocessing \
          gs://himas-mlops-models/models/$${TIMESTAMP}/

  # Upload results
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-results'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        gsutil -m cp -r /workspace/evaluation_results/ \
          gs://himas-mlops-models/evaluation-results/$${TIMESTAMP}/

  # Upload mlflow
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-mlflow'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        gsutil -m cp -r /workspace/mlruns \
          gs://himas-mlops-models/mlflow-runs/$${TIMESTAMP}/

  # Register model
  - name: 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
    id: 'register-model'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd /workspace
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        LATEST_JSON=$$(ls -t evaluation_results/results/*.json | head -1)
        ACC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .accuracy' $$LATEST_JSON)
        REC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .recall' $$LATEST_JSON)
        PREC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .precision' $$LATEST_JSON)
        F1=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .f1_score' $$LATEST_JSON)
        AUC=$$(jq '.metrics_by_hospital[] | select(.hospital=="AGGREGATED") | .roc_auc' $$LATEST_JSON)
        
        cat > model_card.json <<EOF
        {
          "model_info": {
            "name": "himas-federated-mortality-model",
            "version": "$BUILD_ID",
            "timestamp": "$$TIMESTAMP"
          },
          "artifacts": {
            "model_file": "gs://himas-mlops-models/models/$${TIMESTAMP}/model.keras",
            "preprocessing": "gs://himas-mlops-models/models/$${TIMESTAMP}/preprocessing/"
          },
          "performance_metrics": {
            "accuracy": $$ACC,
            "recall": $$REC,
            "precision": $$PREC,
            "f1_score": $$F1,
            "roc_auc": $$AUC
          }
        }
        EOF
        
        gsutil cp model_card.json gs://himas-mlops-models/model-registry/$${TIMESTAMP}.json
        echo "$$TIMESTAMP" > latest_model.txt
        gsutil cp latest_model.txt gs://himas-mlops-models/model-registry/latest.txt

  # Prepare model artifacts for Cloud Run
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'prepare-cloudrun-artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TIMESTAMP=$$(cat /workspace/build_timestamp.txt)
        echo "Preparing artifacts for Cloud Run"
        
        mkdir -p /workspace/PoC/Model-Serving/app/local_model/preprocessing
        
        # Copy model
        cp /workspace/models/model.keras \
          /workspace/PoC/Model-Serving/app/local_model/
        
        # Download preprocessing artifacts
        gsutil -m cp gs://himas-mlops-models/models/$${TIMESTAMP}/preprocessing/*.pkl \
          /workspace/PoC/Model-Serving/app/local_model/preprocessing/
        
        echo "âœ… Artifacts ready"
        ls -lR /workspace/PoC/Model-Serving/app/local_model/

  # Build Cloud Run serving image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-cloudrun-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/himas-cloudrun:$BUILD_ID'
      - '-t'
      - 'gcr.io/$PROJECT_ID/himas-cloudrun:latest'
      - 'PoC/Model-Serving/app'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-cloudrun-image'
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/himas-cloudrun'

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloudrun'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run deploy himas-prediction-service \
          --image=gcr.io/$PROJECT_ID/himas-cloudrun:$BUILD_ID \
          --region=us-central1 \
          --platform=managed \
          --allow-unauthenticated \
          --memory=2Gi \
          --cpu=2 \
          --max-instances=10 \
          --min-instances=1
        
        echo "âœ… Deployed to Cloud Run"
        
        SERVICE_URL=$$(gcloud run services describe himas-prediction-service \
          --region=us-central1 \
          --format='value(status.url)')
        
        echo "ðŸŒ Service URL: $${SERVICE_URL}"
        echo "$${SERVICE_URL}" > /workspace/cloudrun_url.txt

images:
  - 'gcr.io/$PROJECT_ID/himas-training:$BUILD_ID'
  - 'gcr.io/$PROJECT_ID/himas-training:latest'
  - 'gcr.io/$PROJECT_ID/himas-cloudrun:$BUILD_ID'
  - 'gcr.io/$PROJECT_ID/himas-cloudrun:latest'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '3600s'